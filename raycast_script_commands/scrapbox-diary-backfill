#!/bin/bash

# Scrapboxæ—¥è¨˜ãƒšãƒ¼ã‚¸ã®é¡åŠä½œæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ä»Šæ—¥ã‹ã‚‰éå»ã«é¡ã£ã¦ã€å­˜åœ¨ã—ãªã„æ—¥è¨˜ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹
#
# Required parameters:
# @raycast.schemaVersion 1
# @raycast.title Scrapbox Diary Backfill
# @raycast.mode fullOutput
# @raycast.packageName Scrapbox Tools
#
# Optional parameters:
# @raycast.icon ğŸ““
# @raycast.currentDirectoryPath ~
# @raycast.needsConfirmation true
#
# Documentation:
# @raycast.description ä»Šæ—¥ã‹ã‚‰éå»ã«é¡ã£ã¦ã€å­˜åœ¨ã—ãªã„Scrapboxæ—¥è¨˜ãƒšãƒ¼ã‚¸ã‚’è‡ªå‹•ä½œæˆã—ã¾ã™
# @raycast.author r_takaishi
# @raycast.authorURL https://github.com/takaishi

set -e

SCRAPBOX_PROJECT="rtakaishi"
BASE_URL="https://scrapbox.io/${SCRAPBOX_PROJECT}"
BASE_API_URL="https://scrapbox.io/api"

# URL ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰é–¢æ•°
urlencode() {
    local string="${1}"
    local strlen=${#string}
    local encoded=""
    local pos c o

    for (( pos=0 ; pos<strlen ; pos++ )); do
        c=${string:$pos:1}
        case "$c" in
            [-_.~a-zA-Z0-9] ) o="${c}" ;;
            * )               printf -v o '%%%02x' "'$c"
        esac
        encoded+="${o}"
    done
    echo "${encoded}"
}

# æ—¥ä»˜ã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆ
generate_template() {
    local date="$1"
    local year=$(date -j -f "%Y-%m-%d" "$date" "+%Y")
    local year_month=$(date -j -f "%Y-%m-%d" "$date" "+%Y-%m")
    local prev_date=$(date -j -v-1d -f "%Y-%m-%d" "$date" "+%Y-%m-%d")
    local next_date=$(date -j -v+1d -f "%Y-%m-%d" "$date" "+%Y-%m-%d")
    
    cat <<EOF
#Journal #${year} #${year_month}
Prev: [${prev_date}] | Next: [${next_date}]
EOF
}

# ãƒšãƒ¼ã‚¸ã®å­˜åœ¨ç¢ºèªï¼ˆYYYY-MM-DD ã¾ãŸã¯ YYYY-MM-DD_ä»®ï¼‰
check_page_exists() {
    local date="$1"
    local status_code1=$(curl -s -o /dev/null -w "%{http_code}" "${BASE_API_URL}/pages/${SCRAPBOX_PROJECT}/${date}/text")
    echo "${BASE_URL}/${date}: $status_code1"
    local status_code2=$(curl -s -o /dev/null -w "%{http_code}" "${BASE_API_URL}/pages/${SCRAPBOX_PROJECT}/${date}_ä»®/text")
    echo "${BASE_URL}/${date}_ä»®: $status_code2"

    if [ "$status_code1" = "200" ] || [ "$status_code2" = "200" ]; then
        return 0  # ãƒšãƒ¼ã‚¸ãŒå­˜åœ¨
    else
        return 1  # ãƒšãƒ¼ã‚¸ãŒå­˜åœ¨ã—ãªã„
    fi
}

# ãƒšãƒ¼ã‚¸ä½œæˆ
create_page() {
    local date="$1"
    local template=$(generate_template "$date")
    local encoded_template=$(urlencode "$template")
    echo "${BASE_URL}/${date}_ä»®"
    local url="${BASE_URL}/${date}_ä»®?body=${encoded_template}"
    
    echo "Creating page for $date"
    open "$url"
    sleep 2  # ãƒ–ãƒ©ã‚¦ã‚¶ãŒé–‹ãã¾ã§å°‘ã—å¾…ã¤
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    local current_date=$(date "+%Y-%m-%d")
    local missing_dates=()
    
    echo "Starting backfill process from $current_date"
    
    # ã¾ãšã€å­˜åœ¨ã—ãªã„æ—¥ä»˜ã‚’åé›†
    while true; do
        echo "Checking page for $current_date"
        
        if check_page_exists "$current_date"; then
            echo "Page exists for $current_date (either ${current_date} or ${current_date}_ä»®). Stopping search."
            break
        else
            echo "Page does not exist for $current_date"
            missing_dates+=("$current_date")
        fi
        
        # å‰æ—¥ã«ç§»å‹•
        current_date=$(date -j -v-1d -f "%Y-%m-%d" "$current_date" "+%Y-%m-%d")
    done
    
    # å¤ã„é †ï¼ˆé…åˆ—ã®é€†é †ï¼‰ã§ä½œæˆ
    if [ ${#missing_dates[@]} -gt 0 ]; then
        echo "Creating pages in chronological order..."
        for (( i=${#missing_dates[@]}-1 ; i>=0 ; i-- )); do
            create_page "${missing_dates[i]}"
        done
    else
        echo "No missing pages found."
    fi
    
    echo "Backfill process completed."
}

main "$@"
